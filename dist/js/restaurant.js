let restaurant;var map;navigator.serviceWorker&&navigator.serviceWorker.register("sw.js").then(e=>navigator.serviceWorker.ready).then(()=>{console.log("Registration worked!!")});const reload_reviews_event=new Event("reload_reviews_event");window.initMap=(()=>{fetchRestaurantFromURL((e,t)=>{e?console.error(e):(self.map=new google.maps.Map(document.getElementById("map"),{zoom:16,center:t.latlng,scrollwheel:!1}),fillBreadcrumb(),DBHelper.mapMarkerForRestaurant(self.restaurant,self.map))})}),fetchRestaurantFromURL=(e=>{if(self.restaurant)return void e(null,self.restaurant);const t=getParameterByName("id");t?DBHelper.fetchRestaurantById(t,(t,n)=>{self.restaurant=n,n?(fillRestaurantHTML(),e(null,n)):console.error(t)}):(error="No restaurant id in URL",e(error,null))}),fillPictureRestaurant=((e=self.restaurant)=>{const t=document.getElementById("restaurant-img");t.className="restaurant-img",imageSrc=DBHelper.imageUrlForRestaurant(e),imageExtension=imageSrc.slice(2+(imageSrc.lastIndexOf(".")-1>>>0)),imagePathWhitoutExtension=imageSrc.slice(0,imageSrc.lastIndexOf("."));let n=document.createElement("source");n.className="restaurant-img",n.media="(max-width:350px)",n.srcset=imagePathWhitoutExtension+"_350."+imageExtension,n.type="image/jpeg",t.appendChild(n),(n=document.createElement("source")).className="restaurant-img",n.media="(min-width:351px, max-width:700px)",n.srcset=imagePathWhitoutExtension+"_700."+imageExtension,n.type="image/jpeg",t.appendChild(n);const r=document.createElement("img");r.className="restaurant-img",r.src=imagePathWhitoutExtension+"_800."+imageExtension,r.alt=`Image of ${e.name} restaurant`,t.appendChild(r)}),fillRestaurantHTML=((e=self.restaurant)=>{document.getElementById("restaurant-name").innerHTML=e.name,document.getElementById("restaurant-address").innerHTML=e.address,fillPictureRestaurant(),document.getElementById("restaurant-cuisine").innerHTML=e.cuisine_type,fillFavorite(),e.operating_hours&&fillRestaurantHoursHTML();const t=document.getElementById("reviews-container"),n=document.createElement("h3");n.innerHTML="Reviews",t.appendChild(n),fillFormReview(e.id),fillReviews()}),fillRestaurantHoursHTML=((e=self.restaurant.operating_hours)=>{const t=document.getElementById("restaurant-hours"),n=document.createElement("caption");n.innerHTML="Operating hours:",t.appendChild(n);const r=document.createElement("tr"),i=document.createElement("th");i.setAttribute("scope","col"),i.innerHTML="Day",r.appendChild(i);const a=document.createElement("th");a.innerHTML="Hours",r.appendChild(a),t.appendChild(r);for(let n in e){const r=document.createElement("tr"),i=document.createElement("td");i.innerHTML=n,r.appendChild(i);const a=document.createElement("td");a.innerHTML=e[n],r.appendChild(a),t.appendChild(r)}}),fillReviews=(()=>{console.log("inside fillReviews"),DBHelper.fetchReviewsByRestaurantFromServer(self.restaurant.id).then(e=>fillReviewsHTML(e)).catch(e=>{console.log(e)})}),addPendingReviewToHTML=(e=>{const t=document.getElementById("reviews-list"),n=createReviewHTML(e);t.appendChild(n)}),fillReviewsHTML=(e=>{const t=document.getElementById("reviews-container");if(document.getElementById("reviews-list"))document.getElementById("reviews-list").innerHTML="";else{const e=document.createElement("reviews-list");e.setAttribute("id","reviews-list"),e.classList.add("reviews-list"),t.appendChild(e)}if(!e){const e=document.createElement("p");return e.innerHTML="No reviews yet!",void t.appendChild(e)}const n=document.getElementById("reviews-list");e.forEach(e=>{n.appendChild(createReviewHTML(e))}),t.appendChild(n)}),createReviewHTML=(e=>{const t=document.createElement("li");t.classList.add("review-wraper");const n=document.createElement("div");n.classList.add("review-header"),t.appendChild(n);const r=document.createElement("p");r.innerHTML=e.name,r.classList.add("review-name"),n.appendChild(r);const i=document.createElement("p");dateString=new Date(e.createdAt),i.innerHTML=dateString.toLocaleString(),i.classList.add("review-date"),n.appendChild(i);const a=document.createElement("p");a.innerHTML=`Rating: ${e.rating}`,a.classList.add("review-rating"),t.appendChild(a);const s=document.createElement("p");return s.innerHTML=e.comments,s.classList.add("review-comments"),t.appendChild(s),t}),fillBreadcrumb=((e=self.restaurant)=>{const t=document.getElementById("breadcrumb"),n=document.createElement("li");n.innerHTML=e.name,n.setAttribute("aria-current","page"),t.appendChild(n)}),getParameterByName=((e,t)=>{t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");const n=new RegExp(`[?&]${e}(=([^&#]*)|&|#|$)`).exec(t);return n?n[2]?decodeURIComponent(n[2].replace(/\+/g," ")):"":null});var VK_ENTER=13,VK_SPACE=32,VK_LEFT=37,VK_UP=38,VK_RIGHT=39,VK_DOWN=40,focusedIdx=0;function slice(e){return Array.prototype.slice.call(e)}unlightRating=(()=>{const e=document.getElementsByClassName("rating-radio");for(var t=0;t<e.length;t++)e[t].setAttribute("src","../img/star_normal.svg")}),higlightRatingImage=(e=>{document.getElementById(e).setAttribute("src","../img/star_highlight.svg")}),highlightRating=(e=>{if(unlightRating(),0!=e)for(var t=1;t<=e;t++)higlightRatingImage("r"+t)}),getRateFromId=(e=>(idx=Number(e.substr(1,1)),idx)),updateRatingField=(e=>{document.getElementById("rating").setAttribute("value",e)}),updateRate=(e=>{for(el of(unlightRating(),rate=getRateFromId(e),highlightRating(rate),ratingElements=document.getElementsByClassName("rating-radio"),ratingElements))el.setAttribute("aria-checked","false"),el.setAttribute("tabindex","-1");updateRatingElement=document.getElementById(e),updateRatingElement.setAttribute("aria-checked","true"),updateRatingElement.setAttribute("tabindex","0"),updateRatingField(rate)}),fillFormReview=(e=>{const t=document.getElementById("form-review-container");t.classList.add("form-review-container");const n=document.createElement("h3");n.innerHTML="Send your own review:",n.setAttribute("id","title-form-review"),t.appendChild(n);const r=document.createElement("form");r.setAttribute("action",""),r.setAttribute("method","post"),r.setAttribute("id","form-review"),r.classList.add("form-review"),r.addEventListener("submit",function(e){e.preventDefault(),formData=new FormData(r),DBHelper.saveReviewToServer(formData).then(()=>{document.dispatchEvent(reload_reviews_event)}).then(fillReviews()).then(r.reset()).catch(e=>{console.log(e);var t={};formData.forEach(function(e,n){t[n]=e}),now=Date.now(),t.createdAt=now,DBHelper.savePendingReview(t).then(addPendingReviewToHTML(t)).then(r.reset()),navigator.serviceWorker.ready.then(function(e){e.sync.register("review-submission")})})}),r.addEventListener("reload_reviews_event",function(e){console.log("inside reload_reviews_event"),fillReviews()});const i=document.createElement("input");i.setAttribute("type","hidden"),i.setAttribute("value",e),i.setAttribute("name","restaurant_id"),i.setAttribute("id","restaurant_id"),r.appendChild(i);const a=document.createElement("label");a.setAttribute("for","name"),a.innerHTML="Name: ",r.appendChild(a);const s=document.createElement("input");s.setAttribute("type","text"),s.setAttribute("name","name"),s.setAttribute("id","name"),s.setAttribute("required",""),r.appendChild(s);const o=document.createElement("label");o.setAttribute("for","comment"),o.innerHTML="Comment: ",r.appendChild(o);const d=document.createElement("textarea");d.setAttribute("name","comments"),d.setAttribute("id","comments"),d.setAttribute("cols","30"),d.setAttribute("rows","10"),d.setAttribute("required",""),r.appendChild(d);const c=document.createElement("input");c.setAttribute("type","hidden"),c.setAttribute("name","rating"),c.setAttribute("id","rating"),r.appendChild(c);const l=document.createElement("label");l.setAttribute("for","rating-container"),l.innerHTML="Rate restaurant: ",r.appendChild(l);const u=document.createElement("div");u.setAttribute("id","rating-container"),u.setAttribute("role","radiogroup"),u.setAttribute("aria-labelledby","title-form-review"),u.classList.add("rating-container"),u.addEventListener("keydown",handleKeyDown.bind(this)),focusedIdx=0;for(var m=1;m<=5;m++){const e=m,t=document.createElement("img");t.setAttribute("src","../img/star_normal.svg"),t.setAttribute("role","radio"),1==m?t.setAttribute("tabindex","0"):t.setAttribute("tabindex","-1"),t.setAttribute("alt",m+" star"),t.setAttribute("name","rate"+m),t.setAttribute("id","r"+m),t.setAttribute("aria-checked","false"),t.classList.add("rating-radio"),t.onfocus=function(){0==focusedIdx&&(focusedIdx=1,updateRate("r1"))},t.onclick=function(t){for(var n=1;n<=e;n++)higlightRatingImage("r"+n);focusedIdx=e,updateRate(t.target.id)},t.onmouseover=function(e){idx=e.target.id,currentIndex=Number(idx.substr(1,1)),unlightRating(),highlightRating(currentIndex)},t.onmouseout=function(){unlightRating();for(var e=1;e<=focusedIdx;e++)higlightRatingImage("r"+e)},u.appendChild(t)}r.appendChild(u);const g=document.createElement("input");return g.setAttribute("type","submit"),g.setAttribute("value","submit review"),g.setAttribute("id","submitButton"),g.onclick=function(){unlightRating(),focusedIdx=0},r.appendChild(g),t.appendChild(r),t}),handleKeyDown=function(e){let t;switch(e.keyCode){case VK_UP:case VK_LEFT:e.preventDefault(),--focusedIdx<=0&&(focusedIdx=5),document.getElementById("r"+focusedIdx).focus(),updateRate("r"+focusedIdx);break;case VK_DOWN:case VK_RIGHT:e.preventDefault(),++focusedIdx>5&&(focusedIdx=1),document.getElementById("r"+focusedIdx).focus(),updateRate("r"+focusedIdx);break;case VK_SPACE:{e.preventDefault();const n=slice(document.querySelectorAll(".rating-radio"));t=e.target;const r=n.indexOf(t)+1;if(updateRate(t.id),r<0)return;focusedIdx=r,document.getElementById("submitButton").focus();break}default:return}unlightRating(),highlightRating(focusedIdx)},"indexedDB"in window||console.log("This browser doesn't support IndexedDB");var dbPromise=idb.open("reviewsDB",3,function(e){if(!e.objectStoreNames.contains("reviews"))e.createObjectStore("reviews",{keyPath:"id"})});dbPromise.then(e=>{DBHelper.fetchReviewsFromServer((t,n)=>{n.forEach(function(t){var n=e.transaction("reviews","readwrite").objectStore("reviews");t.pendingToUpdateFavorite=!1,n.put(t)})})});var dbPendingPromise=idb.open("pendingReviewsDB",1,function(e){if(!e.objectStoreNames.contains("pendingReviews"))e.createObjectStore("pendingReviews",{autoIncrement:!0})});function toggleCheckbox(e){var t=e.currentTarget,n=t.getElementsByTagName("img")[0],r=t.getAttribute("aria-checked").toLowerCase();("click"===e.type||"keydown"===e.type&&32===e.keyCode)&&("true"===r?(t.setAttribute("aria-checked","false"),n.src="../img/heart_normal.svg"):(t.setAttribute("aria-checked","true"),n.src="../img/heart_highlight.svg"),e.preventDefault(),e.stopPropagation())}function focusCheckbox(e){e.currentTarget.className+=" focus"}function blurCheckbox(e){e.currentTarget.className=e.currentTarget.className.replace(" focus","")}window.onload=function(){new Event("offline_event");navigator.serviceWorker.addEventListener("message",e=>{"review-submission"===e.data&&(console.log("sending a review-submission message"),DBHelper.fetchPendingReviewsFromIDB().then(e=>{e.forEach(e=>{DBHelper.saveReviewToServer(e)})}).then(DBHelper.clearPendingReviewsIDB(e=>console.log(e)))),"is-favorite-submission"===e.data&&DBHelper.sumbitPendingFavorites()})},fillFavorite=(e=>{favoriteContainer=document.getElementById("favorite-container"),favoriteContainer.classList.add("favorite-container"),titleFavorite=document.createElement("h3"),titleFavorite.innerHTML="Mark as favorite: ",favoriteContainer.appendChild(titleFavorite);let t=document.createElement("div");t.setAttribute("id","checkbox-favorite"),t.setAttribute("type","checkbox"),t.setAttribute("name","checkbox-favorite"),t.setAttribute("role","checkbox"),isFavorite=self.restaurant.is_favorite,t.setAttribute("aria-checked",isFavorite),t.setAttribute("tabindex","0"),t.classList.add("checkbox-favorite");let n=document.createElement("img"),r=1==isFavorite||"true"==isFavorite?"heart_highlight.svg":"heart_normal.svg";n.setAttribute("src","../img/"+r),n.setAttribute("id","image-favorite"),n.setAttribute("alt","Mark as favorite"),n.setAttribute("name","img"),t.appendChild(n),t.onclick=(e=>{toggleCheckbox(e),DBHelper.toggleFavorite(self.restaurant)}),t.onkeydown=(e=>{toggleCheckbox(e)}),favoriteContainer.appendChild(t)});